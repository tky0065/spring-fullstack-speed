#!/usr/bin/env node
/**
 * Script de g√©n√©ration automatique des clients API TypeScript pour Vue
 * Ce script facilite la g√©n√©ration des clients API √† partir de la documentation OpenAPI
 *
 * Usage:
 *   npm run api                     - G√©n√®re les clients API avec les param√®tres par d√©faut
 *   npm run api -- --url=<URL>      - Utilise une URL sp√©cifique pour la documentation OpenAPI
 *   npm run api -- --output=<PATH>  - Sp√©cifie un dossier de sortie personnalis√©
 *   npm run api -- --help           - Affiche l'aide
 */

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

// Analyser les arguments de la ligne de commande
const args = process.argv.slice(2);
const options = {
  url: 'http://localhost:8080/v3/api-docs',
  output: './src/api',
  generator: 'typescript-axios',
  help: false,
  skipValidation: false
};

// Traitement des arguments
args.forEach(arg => {
  if (arg === '--help' || arg === '-h') {
    options.help = true;
  } else if (arg === '--skip-validation') {
    options.skipValidation = true;
  } else if (arg.startsWith('--url=')) {
    options.url = arg.split('=')[1];
  } else if (arg.startsWith('--output=')) {
    options.output = arg.split('=')[1];
  } else if (arg.startsWith('--generator=')) {
    options.generator = arg.split('=')[1];
  }
});

// Afficher l'aide si demand√©
if (options.help) {
  console.log('üöÄ G√©n√©rateur de clients API √† partir de la documentation OpenAPI');
  console.log('');
  console.log('Usage:');
  console.log('  npm run api                       - G√©n√®re les clients API avec les param√®tres par d√©faut');
  console.log('  npm run api -- --url=<URL>        - Utilise une URL sp√©cifique pour la documentation OpenAPI');
  console.log('  npm run api -- --output=<PATH>    - Sp√©cifie un dossier de sortie personnalis√©');
  console.log('  npm run api -- --generator=<TYPE> - Sp√©cifie le type de g√©n√©rateur (typescript-axios par d√©faut)');
  console.log('  npm run api -- --skip-validation  - Saute la validation du serveur');
  console.log('  npm run api -- --help             - Affiche cette aide');
  console.log('');
  console.log('Exemples:');
  console.log('  npm run api -- --url=http://localhost:8080/v3/api-docs');
  console.log('  npm run api -- --output=./src/api-clients');
  console.log('  npm run api -- --generator=typescript-fetch');
  process.exit(0);
}

// Fonction principale
async function generateApi() {
  console.log('üöÄ G√©n√©ration des clients API depuis la documentation OpenAPI...');
  console.log('');

  try {
    // V√©rifier si le serveur est accessible (sauf si --skip-validation est utilis√©)
    if (!options.skipValidation) {
      console.log(`V√©rification de la disponibilit√© du serveur √† ${options.url}...`);
      try {
        execSync(`curl -s -o /dev/null -w "%{http_code}" ${options.url}`);
        console.log('‚úÖ Serveur accessible, documentation OpenAPI disponible');
      } catch (error) {
        console.log('‚ùå Serveur non accessible ou documentation OpenAPI non disponible');
        console.log('‚ö†Ô∏è Assurez-vous que votre serveur Spring Boot est d√©marr√© et que SpringDoc est configur√©');
        console.log('üí° Vous pouvez utiliser --skip-validation pour ignorer cette v√©rification');
        process.exit(1);
      }
    }

    // Cr√©er le dossier de sortie s'il n'existe pas
    const outputDir = path.resolve(process.cwd(), options.output);
    if (!fs.existsSync(outputDir)) {
      console.log(`Cr√©ation du dossier de sortie: ${outputDir}`);
      fs.mkdirSync(outputDir, { recursive: true });
    }

    // Ex√©cuter la commande de g√©n√©ration API
    console.log(`G√©n√©ration des clients TypeScript avec le g√©n√©rateur ${options.generator}...`);

    // Construire la commande openapi-generator-cli
    const command = `npx @openapitools/openapi-generator-cli generate \
      -i ${options.url} \
      -g ${options.generator} \
      -o ${options.output} \
      --additional-properties=withInterfaces=true,supportsES6=true,npmName=@api/client,modelPropertyNaming=original`;

    execSync(command, { stdio: 'inherit' });

    console.log('');
    console.log('‚úÖ G√©n√©ration des clients API termin√©e avec succ√®s!');
    console.log(`Les clients API ont √©t√© g√©n√©r√©s dans le dossier ${options.output}`);
    console.log('üí° Exemple d\'utilisation avec Vue:');
    console.log('');
    console.log(`import { UserApi } from '${options.output.startsWith('./') ? options.output : './' + options.output}';`);
    console.log(`import { apiConfiguration } from '@/services/apiConfig';`);
    console.log('');
    console.log(`// Dans un composant ou un store Pinia`);
    console.log(`const userApi = new UserApi(apiConfiguration);`);
    console.log('');
    console.log(`// Utiliser l'API`);
    console.log(`const { data } = await userApi.getAllUsers();`);
    console.log(`// ou avec Vue Query`);
    console.log(`const users = useQuery({ queryKey: ['users'], queryFn: () => userApi.getAllUsers().then(res => res.data) });`);

  } catch (error) {
    console.error('‚ùå Erreur lors de la g√©n√©ration des clients API:');
    console.error(error.message);
    process.exit(1);
  }
}

// Ex√©cuter la fonction principale
generateApi();
